<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiến Sĩ Kháng Chiến - Tư Tưởng Hồ Chí Minh</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(45deg, #2c3e50, #34495e, #27ae60);
            background-size: 400% 400%;
            animation: battlefieldMove 15s ease infinite;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        @keyframes battlefieldMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            gap: 12px;
        }
        .stat-panel {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid #e74c3c;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        .health-bar, .spirit-bar {
            width: 200px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
            border: 1px solid #fff;
        }
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .spirit-fill {
            height: 100%;
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .battlefield {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(46, 125, 50, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 69, 19, 0.3) 0%, transparent 50%);
        }
        .player {
            position: absolute;
            width: 50px;
            height: 50px;
            font-size: 40px;
            transition: none;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .enemy {
            position: absolute;
            width: 40px;
            height: 40px;
            font-size: 35px;
            z-index: 50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            filter: drop-shadow(0 0 8px rgba(255,0,0,0.5));
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .boss-enemy {
            position: absolute;
            width: 80px;
            height: 80px;
            font-size: 70px;
            z-index: 60;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.9);
            filter: drop-shadow(0 0 20px rgba(255,0,0,0.8));
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bossPulse 2s ease-in-out infinite;
        }
        @keyframes bossPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .bullet {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ffff00, #ff6b00);
            border-radius: 50%;
            z-index: 75;
            box-shadow: 0 0 10px #ffff00;
        }
        .enemy-bullet {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #ff0000, #8b0000);
            border-radius: 50%;
            z-index: 75;
            box-shadow: 0 0 8px #ff0000;
        }
        .boss-bullet {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #ff00ff, #800080);
            border-radius: 50%;
            z-index: 75;
            box-shadow: 0 0 15px #ff00ff;
        }
        .explosion {
            position: absolute;
            font-size: 60px;
            z-index: 200;
            animation: explode 0.5s ease-out forwards;
            pointer-events: none;
        }
        @keyframes explode {
            0% { transform: scale(0.1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        .question-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #e74c3c;
            z-index: 2000;
            max-width: 900px;
            width: 95%;
            backdrop-filter: blur(15px);
        }
        .question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            text-align: center;
            color: #ecf0f1;
            line-height: 1.4;
        }
        .difficulty-indicator {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .difficulty-easy { color: #2ecc71; }
        .difficulty-medium { color: #f39c12; }
        .difficulty-hard { color: #e74c3c; }
        .difficulty-expert { color: #9b59b6; }
        .difficulty-nightmare { color: #ff0066; }
        .answer-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .answer-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.3;
        }
        .answer-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); }
        .answer-btn.correct { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .answer-btn.incorrect { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            pointer-events: none;
        }
        .wave-indicator {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em; color: #e74c3c; font-weight: bold;
            z-index: 1500; text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            animation: waveAnnounce 2s ease-out forwards;
            pointer-events: none;
        }
        @keyframes waveAnnounce {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        .game-over-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center;
            z-index: 3000; backdrop-filter: blur(15px);
        }
        .game-over-content {
            text-align: center; color: white; background: rgba(231, 76, 60, 0.2);
            padding: 40px; border-radius: 20px; border: 3px solid #e74c3c;
        }
        .restart-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white; border: none; padding: 15px 30px; border-radius: 25px;
            font-size: 1.1em; cursor: pointer; margin-top: 20px; transition: all 0.3s ease;
        }
        .explanation { margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; display: none; }
        #toggle-sound { pointer-events: auto; cursor: pointer; padding: 8px 14px; border-radius: 10px; border: 1px solid #fff; background: #2ecc71; color: #fff; }
        #volume { pointer-events: auto; cursor: pointer; }
        .timer-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12);
            transition: width 0.1s linear;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="game-container">
    <div class="hud">
        <div class="stat-panel">
            <div>🇻🇳 Chiến Sĩ Kháng Chiến</div>
            <div class="health-bar"><div class="health-fill" id="health-bar"></div></div>
            <div>Máu: <span id="health-text">100</span></div>
        </div>

        <div style="text-align: center; color: white; font-size: 1.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
            <div>🏆 Điểm: <span id="score">0</span></div>
            <div>⚡ Làn: <span id="wave">1</span></div>
            <div>🎯 Độ khó: <span id="difficulty-level">Dễ</span></div>
        </div>

        <div class="stat-panel">
            <div>💪 Tinh Thần Cách Mạng</div>
            <div class="spirit-bar"><div class="spirit-fill" id="spirit-bar"></div></div>
            <div>Năng lượng: <span id="spirit-text">100</span></div>
        </div>

        <div class="stat-panel" style="display:flex;align-items:center;gap:10px;">
            <button id="toggle-sound">🔊 Enable Sound</button>
            <div style="color:#fff;">Vol</div>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6">
        </div>
    </div>

    <div class="battlefield" id="battlefield">
        <div class="player" id="player">🪖</div>
    </div>

    <div class="instructions">
        <strong>Điều khiển:</strong><br>
        ⌨️ WASD hoặc ←→↑↓: Di chuyển<br>
        🖱️ Click chuột: Bắn đạn<br>
        💡 Trả lời đúng câu hỏi để được buff!<br>
        ⏰ Câu hỏi có giới hạn thời gian!<br>
        🔥 Boss xuất hiện từ làn 10!<br>
        📈 Độ khó tăng theo điểm: 500, 1000, 2000, 3500
    </div>

    <div class="question-popup" id="question-popup" style="display: none;">
        <div class="difficulty-indicator" id="difficulty-indicator"></div>
        <div class="question-text" id="question-text"></div>
        <div class="timer-bar">
            <div class="timer-fill" id="timer-fill"></div>
        </div>
        <div class="answer-options" id="answer-options"></div>
        <div class="explanation" id="explanation"></div>
    </div>

    <div class="game-over-screen" id="game-over">
        <div class="game-over-content">
            <h1>🇻🇳 Kết Thúc Nhiệm Vụ! 🇻🇳</h1>
            <div style="font-size: 1.5em; margin: 20px 0;">
                Điểm cuối: <span id="final-score">0</span><br>
                Làn đạt được: <span id="final-wave">1</span><br>
                Độ khó cao nhất: <span id="final-difficulty">Dễ</span>
            </div>
            <p>Bạn đã chiến đấu dũng cảm vì tư tưởng Hồ Chí Minh!</p>
            <button class="restart-btn" onclick="restartGame()">🔄 Chiến Đấu Lại</button>
        </div>
    </div>
</div>

<script>
/* ====================== Sound Manager (Web Audio API) ====================== */
class SoundManager {
  constructor() {
    this.ctx = null;
    this.master = null;
    this.enabled = false;
    this.volume = 0.6;
    this._bgmTimer = null;
  }
  init() {
    if (this.enabled) return;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    this.ctx = new AudioContext();
    this.master = this.ctx.createGain();
    this.master.gain.value = this.volume;
    this.master.connect(this.ctx.destination);
    this.enabled = true;
    if (this.ctx.state === "suspended") this.ctx.resume();
  }
  setVolume(v) {
    this.volume = v;
    if (this.master) this.master.gain.value = v;
  }
  _tone({ freq=440, type="square", dur=0.08, attack=0.002, decay=0.06, vol=0.8 }) {
    if (!this.enabled) return;
    const t0 = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    gain.gain.setValueAtTime(0, t0);
    gain.gain.linearRampToValueAtTime(vol, t0 + attack);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + attack + decay);
    osc.connect(gain).connect(this.master);
    osc.start(t0);
    osc.stop(t0 + attack + decay + 0.02);
  }
  _noise({ dur=0.25, vol=0.5, lp=1200 }) {
    if (!this.enabled) return;
    const t0 = this.ctx.currentTime;
    const bufferSize = Math.floor(this.ctx.sampleRate * dur);
    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.9;
    const src = this.ctx.createBufferSource();
    src.buffer = buffer;
    const filter = this.ctx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = lp;
    const gain = this.ctx.createGain();
    gain.gain.setValueAtTime(vol, t0);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    src.connect(filter).connect(gain).connect(this.master);
    src.start(t0);
    src.stop(t0 + dur + 0.02);
  }
  shoot() {
    this._tone({ freq: 900, dur: 0.05, type: "square", vol: 0.5 });
    setTimeout(() => this._tone({ freq: 1500, dur: 0.04, type: "square", vol: 0.4 }), 30);
  }
  explosion() {
    this._noise({ dur: 0.22, vol: 0.6, lp: 1400 });
    setTimeout(() => this._tone({ freq: 80, type: "sine", dur: 0.2, attack: 0.005, decay: 0.22, vol: 0.5 }), 10);
  }
  bossExplosion() {
    this._noise({ dur: 0.5, vol: 0.8, lp: 800 });
    setTimeout(() => this._tone({ freq: 60, type: "sine", dur: 0.4, attack: 0.01, decay: 0.4, vol: 0.7 }), 20);
  }
  popup() { this._tone({ freq: 600, dur: 0.06, type: "triangle", vol: 0.35 }); }
  correct() {
    [880, 1175, 1480].forEach((f, i) => setTimeout(() => this._tone({ freq: f, type: "sine", dur: 0.08, vol: 0.5 }), i * 90));
  }
  incorrect() {
    [300, 220, 160].forEach((f, i) => setTimeout(() => this._tone({ freq: f, type: "sawtooth", dur: 0.09, vol: 0.5 }), i * 70));
  }
  timeout() {
    [400, 350, 300, 250].forEach((f, i) => setTimeout(() => this._tone({ freq: f, type: "triangle", dur: 0.1, vol: 0.4 }), i * 100));
  }
  gameover() {
    [440, 330, 220, 150].forEach((f, i) => setTimeout(() => this._tone({ freq: f, type: "triangle", dur: 0.18, vol: 0.6 }), i * 160));
  }
  bossWarning() {
    [200, 400, 200, 400].forEach((f, i) => setTimeout(() => this._tone({ freq: f, type: "sawtooth", dur: 0.3, vol: 0.6 }), i * 300));
  }
  startBGM() {
    if (!this.enabled || this._bgmTimer) return;
    const pattern = [523, 587, 659, 523, 523, 587, 659, 698];
    let idx = 0;
    this._bgmTimer = setInterval(() => {
      this._tone({ freq: pattern[idx % pattern.length], type: "sine", dur: 0.12, vol: 0.25 });
      idx++;
    }, 320);
  }
  stopBGM() {
    if (this._bgmTimer) { clearInterval(this._bgmTimer); this._bgmTimer = null; }
  }
}
const SND = new SoundManager();

// Game variables
let player = { x: 400, y: 500, health: 100, spirit: 100 };
let enemies = [];
let bullets = [];
let enemyBullets = [];
let score = 0;
let wave = 1;
let gameRunning = true;
let questionActive = false;
let keys = {};
let lastEnemySpawn = 0;
let currentQuestionIndex = 0;
let questionTimer = null;
let questionTimeLeft = 0;
let currentDifficulty = 'easy';
let maxDifficultyReached = 'easy';
let bossActive = false;

// Cập nhật câu hỏi với ngưỡng điểm mới và nhiều câu hỏi hơn
const questions = {
  easy: [
    {
      question: "Theo Hồ Chí Minh, nhà nước ta là nước gì?",
      answers: ["Nước dân chủ vì dân", "Nước phong kiến cũ", "Nước tư bản chủ nghĩa", "Nước quân chủ lập hiến"],
      correct: 0,
      explanation: "Hồ Chí Minh khẳng định: 'Nước ta là nước dân chủ, bao nhiêu lợi ích đều vì dân, bao nhiêu quyền hạn đều của dân.'",
      timeLimit: 15
    },
    {
      question: "Quyền hành và lực lượng đều ở đâu theo tư tưởng Hồ Chí Minh?",
      answers: ["Ở nơi dân chúng", "Ở nơi chính phủ", "Ở nơi quân đội", "Ở nơi các quan lại"],
      correct: 0,
      explanation: "Bác Hồ khẳng định: 'Quyền hành và lực lượng đều ở nơi dân.'",
      timeLimit: 12
    },
    {
      question: "Hồ Chí Minh nói: 'Việc gì có lợi cho dân, ta phải...'?",
      answers: ["Hết sức làm ngay", "Cân nhắc kỹ lưỡng", "Báo cáo cấp trên", "Thảo luận tập thể"],
      correct: 0,
      explanation: "'Việc gì có lợi cho dân, ta phải hết sức làm. Việc gì có hại cho dân, ta phải hết sức tránh.'",
      timeLimit: 12
    },
    {
      question: "Theo Hồ Chí Minh, cán bộ là gì của nhân dân?",
      answers: ["Là công bộc trung thành", "Là người lãnh đạo", "Là quan cách mạng", "Là thầy dạy học"],
      correct: 0,
      explanation: "Hồ Chí Minh nhiều lần nhấn mạnh cán bộ, đảng viên phải là đầy tớ trung thành của nhân dân.",
      timeLimit: 15
    },
    {
      question: "Nhà nước do ai lập nên theo tư tưởng Hồ Chí Minh?",
      answers: ["Do nhân dân lập nên", "Do chính phủ thành lập", "Do quân đội xây dựng", "Do các đảng phái tạo ra"],
      correct: 0,
      explanation: "Nhà nước do nhân dân lập nên thông qua hình thức bầu cử tự do, dân chủ.",
      timeLimit: 14
    },
    {
      question: "Dân chủ là để làm gì theo Hồ Chí Minh?",
      answers: ["Để dân được nói, bày tỏ ý kiến", "Để dân được nghe lệnh", "Để dân được bảo vệ", "Để dân được học tập"],
      correct: 0,
      explanation: "'Dân chủ là để làm sao cho dân được mở miệng ra, được nói, được bày tỏ ý kiến của mình.'",
      timeLimit: 16
    },
    {
      question: "Nhân dân có quyền gì với những đại biểu không xứng đáng?",
      answers: ["Có quyền bãi miễn", "Chỉ được góp ý", "Phải chờ hết nhiệm kỳ", "Không được làm gì"],
      correct: 0,
      explanation: "Nếu những đại biểu được nhân dân lựa chọn không còn xứng đáng, nhân dân có quyền bãi miễn.",
      timeLimit: 18
    },
    {
      question: "Theo Hồ Chí Minh, nhân dân tham gia quản lý nhà nước qua hình thức nào?",
      answers: ["Bầu cử, ứng cử, đóng góp ý kiến", "Chỉ thông qua bầu cử", "Chỉ được đóng góp ý kiến", "Chỉ được ứng cử"],
      correct: 0,
      explanation: "Người dân tham gia vào quản lý thông qua bầu cử, ứng cử, đóng góp ý kiến, phản biện xã hội.",
      timeLimit: 20
    },
    {
      question: "Bản chất dân chủ của nhà nước XHCN Việt Nam thể hiện ở điều gì?",
      answers: ["Quyền lực thuộc về nhân dân", "Chính phủ mạnh mẽ", "Quân đội hùng mạnh", "Kinh tế phát triển"],
      correct: 0,
      explanation: "Thể hiện bản chất dân chủ của nhà nước xã hội chủ nghĩa Việt Nam - quyền lực thuộc về nhân dân.",
      timeLimit: 17
    },
    {
      question: "Nhà nước phải xuất phát từ điều gì theo Hồ Chí Minh?",
      answers: ["Từ lợi ích nhân dân", "Từ lợi ích quốc gia", "Từ truyền thống dân tộc", "Từ xu hướng thế giới"],
      correct: 0,
      explanation: "Nhà nước do nhân dân lập nên, phục vụ lợi ích nhân dân.",
      timeLimit: 16
    }
  ],
  medium: [
    {
      question: "Theo Hồ Chí Minh, nhân dân thực hiện quyền lực nhà nước qua hình thức nào?",
      answers: ["Trực tiếp hoặc gián tiếp qua QH, HĐND", "Chỉ thông qua bầu cử", "Chỉ thông qua đại biểu", "Chỉ thông qua Mặt trận"],
      correct: 0,
      explanation: "Nhân dân trực tiếp hoặc gián tiếp thông qua Quốc hội, Hội đồng nhân dân thực hiện quyền lực nhà nước.",
      timeLimit: 20
    },
    {
      question: "Hồ Chí Minh coi việc xây dựng Nhà nước trong sạch, vững mạnh là gì?",
      answers: ["Yếu tố sống còn của chế độ", "Nhiệm vụ quan trọng", "Mục tiêu lâu dài", "Ước mơ cao đẹp"],
      correct: 0,
           explanation: "Hồ Chí Minh luôn coi việc xây dựng một Nhà nước trong sạch, vững mạnh là yếu tố sống còn của chế độ.",
      timeLimit: 22
    },
    {
      question: "Trong sạch có nghĩa là không có những gì theo Hồ Chí Minh?",
      answers: ["Không tham nhũng, đặc quyền, xa dân", "Chỉ không tham nhũng", "Chỉ không có đặc quyền", "Chỉ không xa rời nhân dân"],
      correct: 0,
      explanation: "Trong sạch có nghĩa là không tham nhũng, không đặc quyền đặc lợi, không xa rời nhân dân.",
      timeLimit: 25
    },
    {
      question: "Theo Hồ Chí Minh, quyền lực nhà nước phải được như thế nào?",
      answers: ["Phân công, phối hợp và kiểm soát", "Tập trung tuyệt đối", "Phân tán hoàn toàn", "Để tự nhiên vận hành"],
      correct: 0,
      explanation: "Quyền lực phải được phân công, phối hợp và kiểm soát chặt chẽ.",
      timeLimit: 22
    },
    {
      question: "Hồ Chí Minh yêu cầu cán bộ phải có phẩm chất gì?",
      answers: ["Cần, kiệm, liêm, chính", "Thông minh, khéo léo", "Mạnh mẽ, quyết đoán", "Giàu có, có thế lực"],
      correct: 0,
      explanation: "Mọi cán bộ, đảng viên phải cần, kiệm, liêm, chính, chí công vô tư.",
      timeLimit: 18
    },
    {
      question: "Hồ Chí Minh ví tham nhũng, quan liêu như gì?",
      answers: ["Như giặc nội xâm", "Như bệnh nan y", "Như thảm họa thiên nhiên", "Như kẻ thù ngoại bang"],
      correct: 0,
      explanation: "Người ví tham nhũng, quan liêu như 'giặc nội xâm', nguy hiểm không kém giặc ngoại xâm.",
      timeLimit: 20
    },
    {
      question: "Theo Hồ Chí Minh, bộ máy nhà nước phải như thế nào?",
      answers: ["Gọn nhẹ, hiệu quả, gần dân", "To lớn, uy quyền", "Phức tạp, chặt chẽ", "Đơn giản, thụ động"],
      correct: 0,
      explanation: "Xây dựng bộ máy gọn nhẹ, hiệu quả, gần gũi với nhân dân.",
      timeLimit: 24
    },
    {
      question: "Hồ Chí Minh nói: 'Cán bộ là gốc của...'?",
      answers: ["Mọi công việc", "Sự thành công", "Cách mạng", "Đất nước"],
      correct: 0,
      explanation: "Cán bộ là gốc của mọi công việc - nhấn mạnh vai trò quan trọng của đội ngũ cán bộ.",
      timeLimit: 16
    },
    {
      question: "Theo Hồ Chí Minh, chọn cán bộ phải chọn người như thế nào?",
      answers: ["Có đức, có tài", "Chỉ có tài năng", "Chỉ có đạo đức", "Có quan hệ tốt"],
      correct: 0,
      explanation: "Hồ Chí Minh yêu cầu chọn người có đức, có tài, vừa 'hồng' vừa 'chuyên'.",
      timeLimit: 19
    },
    {
      question: "Nhà nước pháp quyền XHCN là nhà nước quản lý xã hội bằng gì?",
      answers: ["Bằng pháp luật", "Bằng quyền lực", "Bằng truyền thống", "Bằng kinh nghiệm"],
      correct: 0,
      explanation: "Nhà nước pháp quyền XHCN là nhà nước quản lý xã hội bằng pháp luật, bảo đảm quyền lực thuộc về nhân dân.",
      timeLimit: 23
    }
  ],
  hard: [
    {
      question: "Hồ Chí Minh khẳng định bản chất của nhà nước dân chủ là 'bao nhiêu lợi ích đều vì dân, bao nhiêu quyền hạn đều của dân'. Điều này thể hiện nguyên tắc nào?",
      answers: ["Dân là chủ thể tối cao quyền lực", "Nhà nước là trung tâm quyền lực", "Đảng lãnh đạo tuyệt đối", "Chính phủ điều hành mọi việc"],
      correct: 0,
      explanation: "Thể hiện sâu sắc quan điểm dân là chủ, dân là chủ thể tối cao của quyền lực nhà nước.",
      timeLimit: 30
    },
    {
      question: "Theo Hồ Chí Minh, nguồn gốc quyền lực nhà nước từ đâu mà ra?",
      answers: ["Từ nhân dân mà ra", "Từ hiến pháp quy định", "Từ truyền thống lịch sử", "Từ sự ủy quyền quốc tế"],
      correct: 0,
      explanation: "Khẳng định nguồn gốc quyền lực nhà nước là từ nhân dân mà ra.",
      timeLimit: 28
    },
    {
      question: "Hồ Chí Minh nhấn mạnh phòng chống tham nhũng có ý nghĩa gì đối với chế độ?",
      answers: ["Củng cố niềm tin dân với Đảng, Nhà nước", "Chỉ để trừng phạt kẻ xấu", "Tạo sự sợ hãi trong cán bộ", "Thể hiện quyền lực pháp luật"],
      correct: 0,
      explanation: "Phòng, chống tham nhũng góp phần củng cố niềm tin của nhân dân vào Đảng và Nhà nước.",
      timeLimit: 32
    },
    {
      question: "Hồ Chí Minh nhấn mạnh 'kiểm soát quyền lực nhà nước' nhằm ngăn chặn nguy cơ nào?",
      answers: ["Ngăn chặn lạm quyền và lợi ích nhóm", "Ngăn chặn sự yếu kém", "Ngăn chặn thiếu đoàn kết", "Ngăn chặn mất kỷ luật"],
      correct: 0,
      explanation: "Quyền lực phải được kiểm soát chặt chẽ để ngăn chặn tình trạng lạm quyền, lợi ích nhóm.",
      timeLimit: 35
    },
    {
      question: "Theo Hồ Chí Minh, tự phê bình và phê bình là gì của Đảng?",
      answers: ["Vũ khí sắc bén xây dựng Đảng", "Phương pháp học tập", "Hình thức kỷ luật", "Cách thức đoàn kết"],
      correct: 0,
      explanation: "Hồ Chí Minh coi tự phê bình và phê bình là 'vũ khí sắc bén' để xây dựng Đảng.",
      timeLimit: 27
    },
    {
      question: "Hồ Chí Minh cảnh báo chủ nghĩa cá nhân là gì?",
      answers: ["Giặc nội xâm", "Tệ nạn xã hội", "Sai lầm tư tưởng", "Khuyết điểm cá nhân"],
      correct: 0,
      explanation: "Chủ nghĩa cá nhân là 'giặc nội xâm', là nguyên nhân của tham nhũng, quan liêu.",
      timeLimit: 25
    },
    {
      question: "Theo Hồ Chí Minh, pháp luật phải phản ánh điều gì?",
      answers: ["Ý chí, lợi ích của nhân dân", "Chủ trương của Đảng", "Yêu cầu của thời đại", "Kinh nghiệm quốc tế"],
      correct: 0,
      explanation: "Pháp luật phải phản ánh ý chí, lợi ích của nhân dân.",
      timeLimit: 26
    },
    {
      question: "Cải cách hành chính cần đạt mục tiêu gì theo tư tưởng Hồ Chí Minh?",
      answers: ["Bộ máy tinh gọn, hiệu quả", "Tăng quyền lực cơ quan", "Giảm chi phí ngân sách", "Tăng tốc độ xử lý"],
      correct: 0,
      explanation: "Bộ máy nhà nước phải tinh gọn, hoạt động hiệu lực, hiệu quả, phục vụ nhân dân tốt nhất.",
      timeLimit: 29
    },
    {
      question: "Theo Hồ Chí Minh, nhà nước phải tôn trọng và bảo đảm điều gì?",
      answers: ["Quyền con người, quyền công dân", "Quyền lực nhà nước", "Quyền của cán bộ", "Quyền của tập thể"],
      correct: 0,
      explanation: "Nhà nước phải tôn trọng, bảo vệ và bảo đảm quyền con người, quyền công dân.",
      timeLimit: 28
    },
    {
      question: "Hồ Chí Minh nói: 'Nếu để hỏng cán bộ thì sẽ...'?",
      answers: ["Làm hỏng công việc và cả chế độ", "Mất uy tín với dân", "Không hoàn thành nhiệm vụ", "Gây thiệt hại kinh tế"],
      correct: 0,
      explanation: "'Cán bộ là công bộc của dân. Nếu để hỏng cán bộ thì sẽ làm hỏng công việc và hỏng cả chế độ.'",
      timeLimit: 31
    }
  ],
  expert: [
    {
      question: "Hồ Chí Minh nói: 'Một dân tộc, một Đảng... không nhất định hôm nay và ngày mai vẫn được mọi người yêu mến nếu...' điều gì?",
      answers: ["Sa vào chủ nghĩa cá nhân", "Thiếu năng lực lãnh đạo", "Không theo kịp thời đại", "Mất đi sức mạnh quân sự"],
      correct: 0,
      explanation: "'...nếu lòng dạ không trong sáng nữa, nếu sa vào chủ nghĩa cá nhân' - cảnh báo về nguy cơ từ bên trong.",
      timeLimit: 40
    },
    {
      question: "Theo Hồ Chí Minh, ý nghĩa sâu xa của việc 'tăng cường sự giám sát của nhân dân, Mặt trận và báo chí' là gì?",
      answers: ["Thể hiện bản chất dân chủ thực sự", "Tăng cường kiểm tra kỷ luật", "Phát hiện sai phạm kịp thời", "Tạo áp lực với cán bộ"],
      correct: 0,
      explanation: "Thể hiện bản chất dân chủ thực sự của chế độ, đảm bảo quyền làm chủ của nhân dân.",
      timeLimit: 42
    },
    {
      question: "Hồ Chí Minh coi Đảng vừa là người lãnh đạo, vừa là gì với đặc điểm gì về mối quan hệ với nhân dân?",
      answers: ["Người đầy tớ trung thành của dân", "Người giám sát xã hội", "Người ra quyết định cuối cùng", "Người điều hành bộ máy"],
      correct: 0,
      explanation: "Hồ Chí Minh coi Đảng là 'người lãnh đạo, đồng thời là người đầy tớ trung thành của nhân dân'.",
      timeLimit: 38
    },
    {
      question: "Trong tư tưởng Hồ Chí Minh về xây dựng Đảng, nguyên tắc 'tập trung dân chủ' kết hợp với những nguyên tắc nào để đảm bảo hiệu quả lãnh đạo?",
      answers: ["Tự phê bình và gần dân, hiểu dân", "Chỉ tự phê bình và phê bình", "Chỉ gần dân, hiểu dân, học dân", "Kỷ luật và đoàn kết"],
      correct: 0,
      explanation: "Tư tưởng xây dựng Đảng bao gồm tập trung dân chủ, tự phê bình và phê bình, gần dân, hiểu dân, học dân.",
      timeLimit: 45
    },
    {
      question: "Theo Hồ Chí Minh, việc 'xây dựng đội ngũ cán bộ trẻ, tạo nguồn kế cận vững vàng' thể hiện tư tưởng gì?",
      answers: ["Phát triển bền vững, lâu dài", "Thay đổi thế hệ lãnh đạo", "Đổi mới tư duy quản lý", "Tăng cường sức trẻ"],
      correct: 0,
      explanation: "Thể hiện tầm nhìn phát triển bền vững, đảm bảo sự kế thừa và phát triển lâu dài của cách mạng.",
      timeLimit: 40
    },
    {
      question: "Hồ Chí Minh nhấn mạnh 'cải cách hành chính' cần đạt được mục tiêu nào quan trọng nhất?",
      answers: ["Bộ máy tinh gọn, hiệu quả phục vụ dân", "Tăng quyền lực cho cơ quan nhà nước", "Giảm chi phí ngân sách", "Tăng tốc độ xử lý công việc"],
      correct: 0,
      explanation: "Bộ máy nhà nước phải tinh gọn, hoạt động hiệu lực, hiệu quả, phục vụ nhân dân tốt nhất.",
      timeLimit: 43
    },
    {
      question: "Trong tư tưởng Hồ Chí Minh về nhà nước 'của dân, do dân, vì dân', yếu tố nào được coi là cốt lõi nhất?",
      answers: ["Nhân dân là nguồn gốc mọi quyền lực", "Nhà nước phục vụ nhân dân", "Nhân dân giám sát nhà nước", "Nhà nước bảo vệ nhân dân"],
      correct: 0,
      explanation: "Cốt lõi là khẳng định nhân dân là nguồn gốc, chủ thể của mọi quyền lực nhà nước.",
      timeLimit: 41
    },
    {
      question: "Theo Hồ Chí Minh, việc 'đơn giản hóa thủ tục hành chính, chống quan liêu, cửa quyền' nhằm mục đích gì?",
      answers: ["Nâng cao chất lượng phục vụ dân", "Giảm khối lượng công việc", "Tăng hiệu quả làm việc", "Tiết kiệm thời gian"],
      correct: 0,
      explanation: "Đơn giản hóa thủ tục hành chính, chống quan liêu, cửa quyền để nâng cao chất lượng phục vụ nhân dân.",
      timeLimit: 39
    },
    {
      question: "Hồ Chí Minh coi việc 'khuyến khích và bảo vệ người tố cáo tham nhũng' là biện pháp gì trong đấu tranh chống tham nhũng?",
      answers: ["Phát huy dân chủ, giám sát nhân dân", "Tăng cường pháp luật", "Răn đe cán bộ", "Tạo sức ép xã hội"],
      correct: 0,
      explanation: "Khuyến khích và bảo vệ người tố cáo tham nhũng là cách phát huy vai trò giám sát của nhân dân.",
      timeLimit: 44
    },
    {
      question: "Trong quan điểm Hồ Chí Minh, 'tạo điều kiện để mọi người dân được sống tự do, bình đẳng và hạnh phúc' thể hiện bản chất gì của nhà nước?",
      answers: ["Nhà nước vì dân, phục vụ dân", "Nhà nước bảo vệ trật tự", "Nhà nước quản lý xã hội", "Nhà nước thực thi pháp luật"],
      correct: 0,
      explanation: "Thể hiện bản chất nhà nước vì dân, phục vụ nhân dân, tạo điều kiện cho dân được hạnh phúc.",
      timeLimit: 42
    }
  ],
  nightmare: [
    {
      question: "Hồ Chí Minh cảnh báo: 'Một dân tộc, một Đảng... ngày hôm qua là vĩ đại... không nhất định hôm nay và ngày mai vẫn được yêu mến nếu lòng dạ không trong sáng, sa vào chủ nghĩa cá nhân'. Điều này thể hiện tư tưởng gì sâu sắc nhất?",
      answers: ["Nguy cơ suy thoái từ bên trong", "Tầm quan trọng của đoàn kết", "Sự thay đổi của lịch sử", "Vai trò của nhân dân"],
      correct: 0,
      explanation: "Thể hiện tư tưởng sâu sắc về nguy cơ suy thoái, sụp đổ từ bên trong do chủ nghĩa cá nhân.",
      timeLimit: 50
    },
    {
      question: "Theo Hồ Chí Minh, việc 'phải tiến hành tự phê bình và phê bình nghiêm túc, chân thành, cầu thị, tránh hình thức' nhằm đạt được mục tiêu chiến lược nào?",
      answers: ["Cả tập thể và cá nhân tự soi, tự sửa", "Tăng cường kỷ luật tổ chức", "Phát hiện và xử lý sai phạm", "Thống nhất tư tưởng trong Đảng"],
      correct: 0,
      explanation: "Mục tiêu chiến lược là để cả tập thể và cá nhân đều phải tự soi, tự sửa để hoàn thiện.",
      timeLimit: 48
    },
    {
      question: "Hồ Chí Minh khẳng định 'pháp luật phải công bằng, minh bạch, dễ hiểu, dễ thực hiện' và 'xây dựng pháp luật đồng bộ, ổn định, khả thi'. Đây là yêu cầu cốt lõi để xây dựng loại nhà nước nào?",
      answers: ["Nhà nước pháp quyền XHCN", "Nhà nước dân chủ", "Nhà nước trong sạch", "Nhà nước vững mạnh"],
      correct: 0,
      explanation: "Đây là yêu cầu cốt lõi để xây dựng nhà nước pháp quyền xã hội chủ nghĩa.",
      timeLimit: 52
    },
    {
      question: "Trong tư tưởng Hồ Chí Minh, việc 'xử lý nghiêm minh mọi hành vi tham nhũng, không có vùng cấm' kết hợp với 'xây dựng đội ngũ cán bộ liêm chính, công khai tài sản' thể hiện phương châm nào?",
      answers: ["Vừa phòng ngừa, vừa đấu tranh quyết liệt", "Chỉ tập trung vào trừng phạt", "Chỉ tập trung vào giáo dục", "Dựa vào ý thức tự giác"],
      correct: 0,
      explanation: "Thể hiện phương châm toàn diện: vừa phòng ngừa từ gốc, vừa đấu tranh trừng trị quyết liệt.",
      timeLimit: 55
    },
    {
      question: "Hồ Chí Minh nhấn mạnh 'chống suy thoái về tư tưởng chính trị, đạo đức, lối sống trong cán bộ, đảng viên' và 'đổi mới phương thức lãnh đạo của Đảng, gắn bó mật thiết với nhân dân'. Đây là yêu cầu để đạt được mục tiêu gì?",
      answers: ["Nâng cao năng lực lãnh đạo của Đảng", "Tăng cường kỷ luật Đảng", "Mở rộng tổ chức Đảng", "Phát triển đảng viên mới"],
      correct: 0,
      explanation: "Đây là yêu cầu cốt lõi để nâng cao năng lực lãnh đạo, sức chiến đấu của Đảng.",
      timeLimit: 50
    },
    {
      question: "Theo Hồ Chí Minh, 'phòng, chống tham nhũng góp phần củng cố niềm tin của nhân dân vào Đảng và Nhà nước' và 'tạo môi trường xã hội công bằng, minh bạch'. Điều này thể hiện mối quan hệ biện chứng nào?",
      answers: ["Giữa trong sạch và niềm tin nhân dân", "Giữa pháp luật và đạo đức", "Giữa kỷ luật và tự do", "Giữa cá nhân và tập thể"],
      correct: 0,
      explanation: "Thể hiện mối quan hệ biện chứng giữa việc xây dựng Đảng, Nhà nước trong sạch và niềm tin của nhân dân.",
      timeLimit: 53
    },
    {
      question: "Hồ Chí Minh coi 'giữ vững bản chất cách mạng, kiên định mục tiêu độc lập dân tộc và chủ nghĩa xã hội' là nền tảng để thực hiện nhiệm vụ nào quan trọng nhất?",
      answers: ["Xây dựng Đảng thật sự trong sạch, vững mạnh", "Phát triển kinh tế đất nước", "Bảo vệ an ninh quốc gia", "Nâng cao đời sống nhân dân"],
      correct: 0,
      explanation: "Đây là nền tảng tư tưởng để thực hiện nhiệm vụ sống còn: xây dựng Đảng thật sự trong sạch, vững mạnh.",
      timeLimit: 48
    },
    {
      question: "Trong tư tưởng Hồ Chí Minh, 'hoàn thiện cơ chế kiểm soát quyền lực, không để xảy ra lạm quyền' kết hợp với 'phát huy vai trò giám sát của nhân dân, báo chí, các tổ chức xã hội' tạo nên hệ thống gì?",
      answers: ["Kiểm soát quyền lực toàn diện", "Giám sát hành chính", "Phản biện xã hội", "Dân chủ trực tiếp"],
      correct: 0,
      explanation: "Tạo nên hệ thống kiểm soát quyền lực toàn diện, đa chiều từ trong ra ngoài.",
      timeLimit: 54
    },
    {
      question: "Hồ Chí Minh khẳng định 'xây dựng chính quyền điện tử, nâng cao chất lượng phục vụ nhân dân' trong bối cảnh 'đơn giản hóa thủ tục hành chính'. Đây là tư tưởng tiên phong về điều gì?",
      answers: ["Hiện đại hóa bộ máy nhà nước", "Phát triển công nghệ", "Cải cách hành chính", "Phục vụ nhân dân"],
      correct: 0,
      explanation: "Thể hiện tư tưởng tiên phong về hiện đại hóa bộ máy nhà nước phục vụ nhân dân hiệu quả.",
      timeLimit: 51
    },
    {
      question: "Theo Hồ Chí Minh, 'bảo vệ uy tín, vai trò lãnh đạo của Đảng' thông qua việc 'phòng, chống tham nhũng' và 'tạo môi trường xã hội công bằng, minh bạch' thể hiện quy luật nào?",
      answers: ["Uy tín Đảng gắn với sự trong sạch", "Lãnh đạo gắn với phục vụ", "Quyền lực gắn với trách nhiệm", "Đạo đức gắn với năng lực"],
      correct: 0,
      explanation: "Thể hiện quy luật: uy tín, vai trò lãnh đạo của Đảng gắn liền với sự trong sạch, vững mạnh.",
      timeLimit: 56
    }
  ]
};

const enemyTypes = ["🏰", "⚔️", "🛡️", "👑", "🏴‍☠️", "⚡", "🔥", "💀"];
const bossTypes = ["🐉", "👹", "💀", "👺", "🔥", "⚡"];

// Sound UI binding
const btnSound = document.getElementById('toggle-sound');
const volSlider = document.getElementById('volume');

function enableSoundOnce() {
  if (!SND.enabled) {
    SND.init();
    SND.startB
    SND.startBGM();
    if (btnSound) {
      btnSound.textContent = '🔇 Mute';
      btnSound.style.background = '#e67e22';
    }
  }
}

if (btnSound) {
  btnSound.addEventListener('click', () => {
    if (!SND.enabled) {
      enableSoundOnce();
    } else {
      if (SND.master.gain.value > 0) {
        SND.setVolume(0);
        btnSound.textContent = '🔊 Unmute';
        btnSound.style.background = '#2ecc71';
      } else {
        const v = parseFloat(volSlider?.value || '0.6');
        SND.setVolume(v);
        btnSound.textContent = '🔇 Mute';
        btnSound.style.background = '#e67e22';
      }
    }
  });
}

if (volSlider) {
  volSlider.addEventListener('input', (e) => {
    const v = parseFloat(e.target.value);
    if (SND.enabled) SND.setVolume(v);
  });
}

['keydown','mousedown','touchstart'].forEach(evt => {
  window.addEventListener(evt, () => enableSoundOnce(), { once: true });
});

// Event listeners
document.addEventListener('keydown', (e) => { keys[e.key.toLowerCase()] = true; });
document.addEventListener('keyup',   (e) => { keys[e.key.toLowerCase()] = false; });
document.addEventListener('click', (e) => {
  if (!questionActive && gameRunning) {
    shootBullet(e.clientX, e.clientY);
    SND.shoot();
  }
});

// Difficulty management - Cập nhật với ngưỡng điểm mới
function getCurrentDifficulty() {
  if (score >= 3500) return 'nightmare';  // Nightmare từ 3500 điểm
  if (score >= 2000) return 'expert';     // Expert từ 2000 điểm  
  if (score >= 1000) return 'hard';       // Hard từ 1000 điểm
  if (score >= 500) return 'medium';      // Medium từ 500 điểm
  return 'easy';                          // Dễ từ 0-499 điểm
}

function updateDifficultyDisplay() {
  const difficulty = getCurrentDifficulty();
  const difficultyNames = {
    'easy': 'Dễ',
    'medium': 'Trung bình', 
    'hard': 'Khó',
    'expert': 'Chuyên gia',
    'nightmare': 'Ác mộng'
  };
  document.getElementById('difficulty-level').textContent = difficultyNames[difficulty];
  
  const difficultyColors = {
    'easy': '#2ecc71',
    'medium': '#f39c12',
    'hard': '#e74c3c', 
    'expert': '#9b59b6',
    'nightmare': '#ff0066'
  };
  document.getElementById('difficulty-level').style.color = difficultyColors[difficulty];
}

// Utility function to shuffle array
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Initialize game
function initGame() {
  player.x = window.innerWidth / 2 - 25;
  player.y = window.innerHeight - 100;
  updatePlayerPosition();
  updateUI();
  updateDifficultyDisplay();
  
  gameLoop();
}

function updatePlayerPosition() {
  const playerEl = document.getElementById('player');
  playerEl.style.left = player.x + 'px';
  playerEl.style.top  = player.y + 'px';
}

function updateUI() {
  document.getElementById('health-text').textContent = Math.max(0, player.health);
  document.getElementById('spirit-text').textContent = Math.max(0, player.spirit);
  document.getElementById('score').textContent = score;
  document.getElementById('wave').textContent = wave;
  document.getElementById('health-bar').style.width = Math.max(0, player.health) + '%';
  document.getElementById('spirit-bar').style.width = Math.max(0, player.spirit) + '%';
  updateDifficultyDisplay();
}

function handlePlayerMovement() {
  if (!gameRunning || questionActive) return;
  const speed = 5;
  if (keys['w'] || keys['arrowup'])    player.y = Math.max(0, player.y - speed);
  if (keys['s'] || keys['arrowdown'])  player.y = Math.min(window.innerHeight - 50, player.y + speed);
  if (keys['a'] || keys['arrowleft'])  player.x = Math.max(0, player.x - speed);
  if (keys['d'] || keys['arrowright']) player.x = Math.min(window.innerWidth - 50, player.x + speed);
  updatePlayerPosition();
}

function spawnEnemy() {
  if (!gameRunning || questionActive) return;
  
  // Boss spawn every 10 waves
  if (wave % 10 === 0 && !bossActive) {
    spawnBoss();
    return;
  }
  
  const enemyHealth = Math.floor(1 + wave / 3);  // Tăng máu quái nhanh hơn
  const enemyCount = Math.min(5, Math.floor(wave / 2) + 1);  // Nhiều quái hơn
  
  for (let i = 0; i < enemyCount; i++) {
    const enemy = {
      id: Date.now() + Math.random() + i,
      x: Math.random() * (window.innerWidth - 40),
      y: -40 - (i * 80),
      health: enemyHealth,
      maxHealth: enemyHealth,
      type: enemyTypes[Math.floor(Math.random() * enemyTypes.length)],
      lastShot: 0,
      speed: Math.min(6, 1.5 + wave * 0.15),  // Tăng tốc độ
      isBoss: false
    };
    enemies.push(enemy);
    
    const enemyEl = document.createElement('div');
    enemyEl.className = 'enemy';
    enemyEl.id = 'enemy_' + enemy.id;
    enemyEl.textContent = enemy.type;
    enemyEl.style.left = enemy.x + 'px';
    enemyEl.style.top  = enemy.y + 'px';
    
    if (enemy.health > 1) {
      enemyEl.style.fontSize = (35 + enemy.health * 3) + 'px';
      enemyEl.style.filter = `drop-shadow(0 0 ${8 + enemy.health * 2}px rgba(255,0,0,0.8))`;
    }
    
    document.getElementById('battlefield').appendChild(enemyEl);
  }
}

function spawnBoss() {
  bossActive = true;
  SND.bossWarning();
  
  const boss = {
    id: Date.now() + Math.random(),
    x: window.innerWidth / 2 - 40,
    y: -80,
    health: Math.floor(20 + wave * 3),  // Boss có nhiều máu
    maxHealth: Math.floor(20 + wave * 3),
    type: bossTypes[Math.floor(Math.random() * bossTypes.length)],
    lastShot: 0,
    speed: Math.min(3, 1 + wave * 0.05),
    isBoss: true,
    shootPattern: 0
  };
  enemies.push(boss);
  
  const bossEl = document.createElement('div');
  bossEl.className = 'boss-enemy';
  bossEl.id = 'enemy_' + boss.id;
  bossEl.textContent = boss.type;
  bossEl.style.left = boss.x + 'px';
  bossEl.style.top = boss.y + 'px';
  
  document.getElementById('battlefield').appendChild(bossEl);
  
  // Boss warning indicator
  const warning = document.createElement('div');
  warning.className = 'wave-indicator';
  warning.textContent = `⚠️ BOSS XUẤT HIỆN! ⚠️`;
  warning.style.color = '#ff0066';
  document.body.appendChild(warning);
  setTimeout(() => warning.remove(), 3000);
}

function updateEnemies() {
  enemies.forEach((enemy, index) => {
    enemy.y += enemy.speed;
    const enemyEl = document.getElementById('enemy_' + enemy.id);
    if (enemyEl) enemyEl.style.top = enemy.y + 'px';

    if (enemy.y > window.innerHeight) {
      removeEnemy(index);
      if (enemy.isBoss) bossActive = false;
      player.health -= (enemy.isBoss ? 30 : 10);
    }

    // Enhanced enemy shooting patterns
    const shootChance = enemy.isBoss ? 0.1 : Math.min(0.08, 0.02 + wave * 0.003);
    const shootCooldown = enemy.isBoss ? (2000 - wave * 50) : (3000 - wave * 80);
    
    if (Date.now() - enemy.lastShot > shootCooldown && Math.random() < shootChance) {
      if (enemy.isBoss) {
        shootBossPattern(enemy);
      } else {
        shootEnemyBullet(enemy.x + 20, enemy.y + 20);
      }
      enemy.lastShot = Date.now();
    }

    // Collision detection
    const collisionDistance = enemy.isBoss ? 60 : 40;
    if (Math.abs(enemy.x - player.x) < collisionDistance && Math.abs(enemy.y - player.y) < collisionDistance) {
      removeEnemy(index);
      if (enemy.isBoss) bossActive = false;
      player.health -= (enemy.isBoss ? 50 : 20 + enemy.health * 5);
      createExplosion(enemy.x, enemy.y, enemy.isBoss);
    }
  });
}

function shootBossPattern(boss) {
  // Boss bắn theo pattern phức tạp
  const patterns = [
    // Pattern 1: Bắn thẳng
    () => shootBossBullet(boss.x + 40, boss.y + 40, 0, 4),
    // Pattern 2: Bắn tán xạ
    () => {
      for (let i = -2; i <= 2; i++) {
        setTimeout(() => shootBossBullet(boss.x + 40, boss.y + 40, i * 0.5, 3), i * 100);
      }
    },
    // Pattern 3: Bắn theo hướng player
    () => {
      const dx = player.x - boss.x;
      const dy = player.y - boss.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      shootBossBullet(boss.x + 40, boss.y + 40, (dx / distance) * 2, (dy / distance) * 3);
    }
  ];
  
  patterns[boss.shootPattern % patterns.length]();
  boss.shootPattern++;
}

function shootBossBullet(x, y, vx, vy) {
  const bullet = {
    id: Date.now() + Math.random(),
    x: x, y: y,
    vx: vx, vy: vy
  };
  enemyBullets.push(bullet);
  
  const bulletEl = document.createElement('div');
  bulletEl.className = 'boss-bullet';
  bulletEl.id = 'enemybullet_' + bullet.id;
  bulletEl.style.left = bullet.x + 'px';
  bulletEl.style.top = bullet.y + 'px';
  document.getElementById('battlefield').appendChild(bulletEl);

  SND._tone({ freq: 300, type: 'sawtooth', dur: 0.06, vol: 0.4 });
}

function shootBullet(targetX, targetY) {
  if (player.spirit < 5) return;
  player.spirit -= 5;
  const dx = targetX - (player.x + 25);
  const dy = targetY - (player.y + 25);
  const distance = Math.sqrt(dx * dx + dy * dy);
  const bullet = {
    id: Date.now() + Math.random(),
    x: player.x + 25,
    y: player.y + 25,
    vx: (dx / distance) * 8,
    vy: (dy / distance) * 8
  };
  bullets.push(bullet);
  const bulletEl = document.createElement('div');
  bulletEl.className = 'bullet';
  bulletEl.id = 'bullet_' + bullet.id;
  bulletEl.style.left = bullet.x + 'px';
  bulletEl.style.top  = bullet.y + 'px';
  document.getElementById('battlefield').appendChild(bulletEl);
}

function shootEnemyBullet(x, y) {
  const dx = player.x - x;
  const dy = player.y - y;
  const distance = Math.sqrt(dx * dx + dy * dy);
  const speed = Math.min(6, 2.5 + wave * 0.15);  // Tăng tốc đạn
  
  const bullet = {
    id: Date.now() + Math.random(),
    x: x, y: y,
    vx: (dx / distance) * speed,
    vy: (dy / distance) * speed
  };
  enemyBullets.push(bullet);
  const bulletEl = document.createElement('div');
  bulletEl.className = 'enemy-bullet';
  bulletEl.id = 'enemybullet_' + bullet.id;
  bulletEl.style.left = bullet.x + 'px';
  bulletEl.style.top  = bullet.y + 'px';
  document.getElementById('battlefield').appendChild(bulletEl);

  SND._tone({ freq: 400, type: 'square', dur: 0.04, vol: 0.25 });
}

function updateBullets() {
  // Player bullets
  bullets.forEach((bullet, bulletIndex) => {
    bullet.x += bullet.vx;
    bullet.y += bullet.vy;
    const bulletEl = document.getElementById('bullet_' + bullet.id);
    if (bulletEl) {
      bulletEl.style.left = bullet.x + 'px';
      bulletEl.style.top  = bullet.y + 'px';
    }
    enemies.forEach((enemy, enemyIndex) => {
      const hitDistance = enemy.isBoss ? 50 : 25;
      if (Math.abs(bullet.x - enemy.x - (enemy.isBoss ? 40 : 20)) < hitDistance &&
          Math.abs(bullet.y - enemy.y - (enemy.isBoss ? 40 : 20)) < hitDistance) {
        enemy.health--;
        removeBullet(bulletIndex);
        createExplosion(enemy.x, enemy.y, enemy.isBoss);
        
        if (enemy.health <= 0) {
          removeEnemy(enemyIndex);
          if (enemy.isBoss) {
            bossActive = false;
            SND.bossExplosion();
            score += (100 * Math.max(1, Math.floor(wave / 5)));
            
            // Boss death triggers question
            showQuestion();
          } else {
            score += (15 * Math.max(1, Math.floor(wave / 3)));
            
            // Higher chance for questions on higher difficulties
            const questionChances = {
              'easy': 0.3,
              'medium': 0.4,
              'hard': 0.5,
              'expert': 0.6,
              'nightmare': 0.7
            };
            const difficulty = getCurrentDifficulty();
            if (Math.random() < questionChances[difficulty]) {
              showQuestion();
            }
          }
          
          // Wave progression - faster waves
          if (score > 0 && score % (80 + wave * 30) === 0) {
            wave++;
            showWaveIndicator();
          }
        }
      }
    });
    if (bullet.x < 0 || bullet.x > window.innerWidth ||
        bullet.y < 0 || bullet.y > window.innerHeight) {
      removeBullet(bulletIndex);
    }
  });

  // Enemy bullets
  enemyBullets.forEach((bullet, bulletIndex) => {
    bullet.x += bullet.vx;
    bullet.y += bullet.vy;
    const bulletEl = document.getElementById('enemybullet_' + bullet.id);
    if (bulletEl) {
      bulletEl.style.left = bullet.x + 'px';
      bulletEl.style.top  = bullet.y + 'px';
    }
    if (Math.abs(bullet.x - player.x - 25) < 25 &&
        Math.abs(bullet.y - player.y - 25) < 25) {
      removeEnemyBullet(bulletIndex);
      player.health -= (20 + Math.floor(wave / 2));
      createExplosion(player.x, player.y);
    }
    if (bullet.x < 0 || bullet.x > window.innerWidth ||
        bullet.y < 0 || bullet.y > window.innerHeight) {
      removeEnemyBullet(bulletIndex);
    }
  });
}

function showWaveIndicator() {
  const indicator = document.createElement('div');
  indicator.className = 'wave-indicator';
  
  if (wave % 10 === 0) {
    indicator.textContent = `🐉 BOSS WAVE ${wave} 🐉`;
    indicator.style.color = '#ff0066';
  } else {
    indicator.textContent = `🌊 Làn ${wave} 🌊`;
  }
  
  document.body.appendChild(indicator);
  setTimeout(() => indicator.remove(), 2000);
}

function removeBullet(index) {
  if (bullets[index]) {
    const bulletEl = document.getElementById('bullet_' + bullets[index].id);
    if (bulletEl) bulletEl.remove();
    bullets.splice(index, 1);
  }
}

function removeEnemyBullet(index) {
  if (enemyBullets[index]) {
    const bulletEl = document.getElementById('enemybullet_' + enemyBullets[index].id);
    if (bulletEl) bulletEl.remove();
    enemyBullets.splice(index, 1);
  }
}

function removeEnemy(index) {
  if (enemies[index]) {
    const enemyEl = document.getElementById('enemy_' + enemies[index].id);
    if (enemyEl) enemyEl.remove();
    enemies.splice(index, 1);
  }
}

function createExplosion(x, y, isBoss = false) {
  if (isBoss) {
    SND.bossExplosion();
  } else {
    SND.explosion();
  }
  
  const explosion = document.createElement('div');
  explosion.className = 'explosion';
  explosion.textContent = isBoss ? '💥💥💥' : '💥';
  explosion.style.left = x + 'px';
  explosion.style.top  = y + 'px';
  explosion.style.fontSize = isBoss ? '80px' : '60px';
  document.getElementById('battlefield').appendChild(explosion);
  setTimeout(() => { if (explosion.parentNode) explosion.remove(); }, 500);
}

function showQuestion() {
  SND.popup();
  
  const difficulty = getCurrentDifficulty();
  currentDifficulty = difficulty;
  
  const difficultyLevels = ['easy', 'medium', 'hard', 'expert', 'nightmare'];
  if (difficultyLevels.indexOf(difficulty) > difficultyLevels.indexOf(maxDifficultyReached)) {
    maxDifficultyReached = difficulty;
  }
  
  const questionPool = questions[difficulty];
  const randomIndex = Math.floor(Math.random() * questionPool.length);
  const question = questionPool[randomIndex];
  
  questionActive = true;
  questionTimeLeft = question.timeLimit;
  
  const difficultyNames = {
    'easy': 'DỄ',
    'medium': 'TRUNG BÌNH',
    'hard': 'KHÓ', 
    'expert': 'CHUYÊN GIA',
    'nightmare': 'ÁC MỘNG'
  };
  
  const difficultyClasses = {
    'easy': 'difficulty-easy',
    'medium': 'difficulty-medium',
    'hard': 'difficulty-hard',
    'expert': 'difficulty-expert',
    'nightmare': 'difficulty-nightmare'
  };
  
  const indicator = document.getElementById('difficulty-indicator');
  indicator.textContent = `🎯 ${difficultyNames[difficulty]} 🎯`;
  indicator.className = `difficulty-indicator ${difficultyClasses[difficulty]}`;
  
  document.getElementById('question-text').textContent = question.question;
  
  // Shuffle answers and track correct position
  const answersWithIndex = question.answers.map((answer, index) => ({
    text: answer,
    isCorrect: index === question.correct
  }));
  
  const shuffledAnswers = shuffleArray(answersWithIndex);
  const newCorrectIndex = shuffledAnswers.findIndex(answer => answer.isCorrect);
  
  const optionsContainer = document.getElementById('answer-options');
  optionsContainer.innerHTML = '';
  shuffledAnswers.forEach((answer, index) => {
    const button = document.createElement('button');
    button.className = 'answer-btn';
    button.textContent = answer.text;
    button.onclick = () => selectAnswer(index, { ...question, correct: newCorrectIndex });
    optionsContainer.appendChild(button);
  });
  
  document.getElementById('explanation').style.display = 'none';
  document.getElementById('question-popup').style.display = 'block';
  
  startQuestionTimer(question);
}

function startQuestionTimer(question) {
  const timerFill = document.getElementById('timer-fill');
  timerFill.style.width = '100%';
  
  questionTimer = setInterval(() => {
    questionTimeLeft--;
    const percentage = (questionTimeLeft / question.timeLimit) * 100;
    timerFill.style.width = percentage + '%';
    
    if (questionTimeLeft <= 0) {
      clearInterval(questionTimer);
      timeoutQuestion(question);
    }
  }, 1000);
}

function timeoutQuestion(question) {
  SND.timeout();
  
  const buttons = document.querySelectorAll('.answer-btn');
  buttons.forEach(btn => btn.disabled = true);
  buttons[question.correct].classList.add('correct');
  
  player.health -= 20;  // Penalty tăng cho timeout
  
  document.getElementById('explanation').textContent = 
    `⏰ Hết thời gian! ${question.explanation}`;
  document.getElementById('explanation').style.display = 'block';
  
  setTimeout(() => {
    document.getElementById('question-popup').style.display = 'none';
    questionActive = false;
  }, 3000);
}

function selectAnswer(selectedIndex, question) {
  if (questionTimer) {
    clearInterval(questionTimer);
    questionTimer = null;
  }
  
  const buttons = document.querySelectorAll('.answer-btn');
  buttons.forEach(btn => btn.disabled = true);

  const difficultyMultipliers = {
    'easy': 1,
    'medium': 1.5,
    'hard': 2,
    'expert': 3,
    'nightmare': 4
  };
  
  const multiplier = difficultyMultipliers[currentDifficulty];

  if (selectedIndex === question.correct) {
    buttons[selectedIndex].classList.add('correct');
    
    const timeBonus = Math.floor((questionTimeLeft / question.timeLimit) * 30);
    const healthReward = Math.floor((25 + timeBonus) * multiplier);
    const spiritReward = Math.floor((35 + timeBonus) * multiplier);
    const scoreReward = Math.floor((75 + timeBonus * 3) * multiplier);
    
    player.health = Math.min(100, player.health + healthReward);
    player.spirit = Math.min(100, player.spirit + spiritReward);
    score += scoreReward;
    
    SND.correct();
    
    document.getElementById('explanation').textContent = 
      `✅ Chính xác! +${healthReward} máu, +${spiritReward} tinh thần, +${scoreReward} điểm. ${question.explanation}`;
  } else {
    buttons[selectedIndex].classList.add('incorrect');
    buttons[question.correct].classList.add('correct');
    
    const healthPenalty = Math.floor(15 * multiplier);
    player.health -= healthPenalty;
    
    SND.incorrect();
    
    document.getElementById('explanation').textContent = 
      `❌ Sai rồi! -${healthPenalty} máu. ${question.explanation}`;
  }

  document.getElementById('explanation').style.display = 'block';

  setTimeout(() => {
    document.getElementById('question-popup').style.display = 'none';
    questionActive = false;
  }, 4000);
}

function checkGameOver() {
  if (player.health <= 0) {
    gameRunning = false;
    document.getElementById('final-score').textContent = score;
    document.getElementById('final-wave').textContent = wave;
    
    const difficultyNames = {
      'easy': 'Dễ',
      'medium': 'Trung bình',
      'hard': 'Khó',
      'expert': 'Chuyên gia',
      'nightmare': 'Ác mộng'
    };
    document.getElementById('final-difficulty').textContent = difficultyNames[maxDifficultyReached];
    
    document.getElementById('game-over').style.display = 'flex';
    SND.gameover();
    SND.stopBGM();
  }
}

function restartGame() {
  player = { x: window.innerWidth / 2 - 25, y: window.innerHeight - 100, health: 100, spirit: 100 };
  enemies = [];
  bullets = [];
  enemyBullets = [];
  score = 0;
  wave = 1;
  gameRunning = true;
  questionActive = false;
  currentQuestionIndex = 0;
  currentDifficulty = 'easy';
  maxDifficultyReached = 'easy';
  bossActive = false;
  
  if (questionTimer) {
    clearInterval(questionTimer);
    questionTimer = null;
  }

  const battlefield = document.getElementById('battlefield');
  Array.from(battlefield.children).forEach(child => {
    if (child.id !== 'player') child.remove();
  });

  document.getElementById('game-over').style.display = 'none';
  updatePlayerPosition();
  updateUI();

  if (SND.enabled) SND.startBGM();
}

function gameLoop() {
  if (!gameRunning) { requestAnimationFrame(gameLoop); return; }
  
  handlePlayerMovement();
  updateEnemies();
  updateBullets();

  // Spirit regeneration
  if (player.spirit < 100) player.spirit = Math.min(100, player.spirit + 0.4);

  // Dynamic enemy spawning based on wave
  const spawnInterval = Math.max(400, 1500 - (wave * 60)); // Spawn nhanh hơn
  if (Date.now() - lastEnemySpawn > spawnInterval) {
    spawnEnemy();
    lastEnemySpawn = Date.now();
  }

  updateUI();
  checkGameOver();
  requestAnimationFrame(gameLoop);
}

window.addEventListener('load', () => { 
  initGame(); 
  lastEnemySpawn = Date.now();
});
</script>
</body>
</html>
